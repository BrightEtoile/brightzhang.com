<!DOCTYPE html>
<html lang="zh" >

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Title -->
    
    <title>Flask+uWSGI+Nginx部署HTTPS - BRIGHTON ZHANG</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    
    <link href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

</head>


<body  data-spy="scroll" data-target="#tocScrollspy"  >

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">BRIGHTON</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    
<header class="intro-header" style="background-image: url('g56bkbgcucdrk.png')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <!-- Tags and categories -->
                        
                            <div class="post-tag-category">
                                
                                
  <div class="post-category">
    <a class="post-category-link" href="/categories/巧技/">巧技</a>
  </div>

                            </div>
                        

                        <h1>Flask+uWSGI+Nginx部署HTTPS</h1>
                        

                        <span class="meta">
                            <!-- Date and Author -->
                            <p class="post-meta">
    <!-- Date and Author -->
    Posted 
    

    on  <time datetime="2019-07-14T08:03:39.000Z" itemprop="datePublished">07/14/2019</time>

    
</p>
                        </span>
                    </div>
                
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<div class="container">
    <div class="row">
        <!-- Post Main Content -->
        
            <div class="col-lg-8 col-lg-offset-1 col-md-10 " >
        

                <article class="post-article" >
                    <p>近日拟做一款简易阅后即焚web app，选用Flask+uWSGI+Nginx来实现，本文记录相关配置。<br><a id="more"></a> </p>
<p>Flask是一个Python编写的Web开发微框架，基于Werkzeug WSGI和Jinja2 模板引擎。 </p>
<p>WSGI (Web Server Gateway Interface), Web服务器网关接口，一种描述web服务器与web应用程序通信的规范、协议，其规范在PEP3333中有具体描述。<br>uWSGI是一个全功能的web服务器，实现了WSGI协议、uwsgi协议、http协议等。它将HTTP协议转化成语言支持的网络协议。比如把HTTP协议转化成WSGI协议，让Python可以直接使用。<br>uwsgi是uWSGI服务器的独占通信协议，用于与web服务器通信。</p>
<p>Nginx (“engine x”) 是一个开源的，支持高性能、高并发的 Web 服务和代理服务软件。常用来做反向代理，动/静态资源分离和负载均衡。 </p>
<h1 id="Flask-Run"><a href="#Flask-Run" class="headerlink" title="Flask Run"></a>Flask Run</h1><p>Flask应用已经构建完成，可直接下载使用：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/brightonzhang/mayfly.git</span><br></pre></td></tr></table></figure>
<p>为隔离Python环境，使用python3-venv创建虚拟环境并激活（以后可用<code>deactivate</code>退出虚拟环境）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd mayfly/</span><br><span class="line">python3 -m venv venv</span><br><span class="line">source venv/bin/activate</span><br></pre></td></tr></table></figure>
<p>安装需要的包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install -r deployment/requirements.txt</span><br></pre></td></tr></table></figure>
<p>这里的requirements.txt文件来自<code>pip freeze &gt; requirements.txt</code>。</p>
<p>自此，Flask环境已经配置完成，可以测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flask run</span><br></pre></td></tr></table></figure>
<h1 id="uWSGI-Config"><a href="#uWSGI-Config" class="headerlink" title="uWSGI Config"></a>uWSGI Config</h1><p>uWSGI配置文件<code>deployment/uwsgi/mayfly.ini</code>如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">module</span> = %n:app</span><br><span class="line"></span><br><span class="line"><span class="attr">master</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">processes</span> = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">socket</span> = /tmp/uwsgi.%n.sock</span><br><span class="line"><span class="attr">chmod-socket</span> = <span class="number">660</span></span><br><span class="line"><span class="attr">vacuum</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">die-on-term</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>Inside, we will start off with the <code>[uwsgi]</code> header so that uWSGI knows to apply the settings. </p>
<p>The option <code>module</code> has the same effect as the <code>wsgi-file</code> and <code>callable</code>. It specify two things: the module itself, by referring to the <code>mayfly.py</code> file minus the extension, and the callable within the file, <code>app</code>. <code>%n</code> is magic word, means the file name of the configure file, without the extension.</p>
<p>And uWSGI will start up in master mode and spawn five worker processes to serve actual requests.</p>
<p>We’re going to be using Nginx to handle actual client connections, which will then pass requests to uWSGI. Since these components are operating on the same computer, a Unix socket is preferable because it is faster and more secure. We call the socket <code>/tmp/uwsgi.%n.sock</code> and place it in this directory. We also change the permissions on the socket. We’ll be giving the Nginx group ownership of the uWSGI process later on, so we need to make sure the group owner of the socket can read information from it and write to it. We will also clean up the socket when the process stops by adding the <code>vacuum</code> option.</p>
<p>The <code>die-on-term</code> option can help ensure that the init system and uWSGI have the same assumptions about what each process signal means. Setting this aligns the two system components, implementing the expected behavior.</p>
<p>手动启动测试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uwsgi deployment/uwsgi/mayfly.ini</span><br></pre></td></tr></table></figure>
<h1 id="Systemd-Unit-File"><a href="#Systemd-Unit-File" class="headerlink" title="Systemd Unit File"></a>Systemd Unit File</h1><p>Creating a systemd unit file will allow Ubuntu’s init system to automatically start uWSGI and serve the Flask application whenever the server boots.</p>
<p>Create a unit file ending in <code>.service</code> within the <code>/etc/systemd/system</code> directory to begin:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s /home/brighton/mayfly/deployment/systemd/mayfly.service /etc/systemd/system/</span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=uWSGI instance to serve mayfly</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">User</span>=brighton</span><br><span class="line"><span class="attr">Group</span>=www-data</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/home/brighton/mayfly</span><br><span class="line"><span class="attr">Environment</span>=<span class="string">"PATH=/home/brighton/mayfly/venv/bin"</span></span><br><span class="line"><span class="attr">ExecStart</span>=/home/brighton/mayfly/venv/bin/uwsgi --ini deployment/uwsgi/mayfly.ini </span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p>Inside, we’ll start with the <code>[Unit]</code> section, which is used to specify metadata and dependencies. Let’s put a description of our service here and tell the init system to only start this after the networking target has been reached.</p>
<p>Next, let’s open up the <code>[Service]</code> section. This will specify the user and group that we want the process to run under. Let’s give our regular user account ownership of the process since it owns all of the relevant files. Let’s also give group ownership to the <code>www-data</code> group so that Nginx can communicate easily with the uWSGI processes. </p>
<p>Next, let’s map out the working directory and set the <code>PATH</code> environmental variable so that the init system knows that the executables for the process are located within our virtual environment. Let’s also specify the command to start the service. Systemd requires that we give the full path to the uWSGI executable, which is installed within our virtual environment. </p>
<p>Finally, let’s add an <code>[Install]</code> section. This will tell systemd what to link this service to if we enable it to start at boot. We want this service to start when the regular multi-user system is up and running.</p>
<p>We can now control the uWSGI service with <code>systemctl</code>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start mayfly</span><br><span class="line">sudo systemctl enable mayfly</span><br><span class="line">sudo systemctl status mayfly</span><br></pre></td></tr></table></figure>
<h1 id="Nginx-Config"><a href="#Nginx-Config" class="headerlink" title="Nginx Config"></a>Nginx Config</h1><p>We should configure Nginx to pass web requests to that socket using the <code>uwsgi</code> protocol. Begin by creating a new server block configuration file in Nginx’s <code>sites-enabled</code> directory. </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /home/brighton/mayfly/deployment/nginx/mayfly.conf /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> mayfly.brightonzhang.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> /static &#123;</span><br><span class="line">        <span class="attribute">alias</span> /home/brighton/mayfly/app/static; <span class="comment"># your project's static files - amend as required</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">include</span> uwsgi_params;</span><br><span class="line">        <span class="attribute">uwsgi_pass</span> unix:/tmp/uwsgi.mayfly.sock;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We can test for syntax errors and restart the Nginx process:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -t</span><br><span class="line">sudo systemctl restart nginx</span><br></pre></td></tr></table></figure>
<p>If we encounter any errors, trying checking the following:</p>
<ul>
<li><code>sudo less /var/log/nginx/error.log</code>: checks the Nginx error logs.</li>
<li><code>sudo less /var/log/nginx/access.log</code>: checks the Nginx access logs.</li>
<li><code>sudo journalctl -u nginx</code>: checks the Nginx process logs.</li>
<li><code>sudo journalctl -u myproject</code>: checks your Flask app’s uWSGI logs.</li>
</ul>
<p>在Linux上，Nginx默认配置文件在<code>/etc/nginx/</code>下。在macOS上，若采用brew安装，Nginx默认配置文件在<code>/usr/local/etc/nginx/</code>下，目录结构也有差异。可以在<code>nginx.conf</code>第一行指定nginx进程运行用户：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> Brighton staff;</span><br></pre></td></tr></table></figure>
<p>可以使用<code>brew</code>控制Nginx：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo brew services start nginx</span><br></pre></td></tr></table></figure>
<p>当然也可以使用<code>nginx</code>命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx</span><br><span class="line">sudo nginx -t</span><br><span class="line">sudo nginx -s stop</span><br><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>
<h1 id="Certbot"><a href="#Certbot" class="headerlink" title="Certbot"></a>Certbot</h1><p>使用Certbot为域名添加<a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let’s Encrypt</a>证书以支持HTTPS。安装Certbot’s Nginx包并执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:certbot/certbot</span><br><span class="line">sudo apt install python-certbot-nginx</span><br><span class="line">sudo certbot --nginx -d mayfly.brightonzhang.com</span><br></pre></td></tr></table></figure>
<p>Certbot会与Let’s Encrypt通信，审核域名证书请求。如果成功，会自动更新Nginx配置并重启服务。完成之后，会发现<code>deployment/nginx/mayfly.conf</code>多了些<code># managed by Certbot</code>的条目。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world" target="_blank" rel="noopener">The Flask Mega-Tutorial</a><br><a href="https://github.com/luhuisicnu/The-Flask-Mega-Tutorial-zh" target="_blank" rel="noopener">The Flask Mega-Tutorial中文翻译</a><br><a href="https://spacewander.github.io/explore-flask-zh/" target="_blank" rel="noopener">Flask之旅 - explore flask中文翻译</a><br><a href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-uswgi-and-nginx-on-ubuntu-18-04" target="_blank" rel="noopener">How To Serve Flask Applications with uWSGI and Nginx on Ubuntu 18.04</a></p>

                </article>
            </div>

        
            <div class="col-lg-3  col-md-2 hidden-xs hidden-sm" id="tocScrollspy">
                 <aside class="toc-wrap nav" data-spy="affix" data-offset-top="565" >
    <strong class="toc-title">Contents</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flask-Run"><span class="toc-number">1.</span> <span class="toc-text">Flask Run</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#uWSGI-Config"><span class="toc-number">2.</span> <span class="toc-text">uWSGI Config</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Systemd-Unit-File"><span class="toc-number">3.</span> <span class="toc-text">Systemd Unit File</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx-Config"><span class="toc-number">4.</span> <span class="toc-text">Nginx Config</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Certbot"><span class="toc-number">5.</span> <span class="toc-text">Certbot</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">6.</span> <span class="toc-text">参考资料</span></a></li></ol>
</aside>
            </div>
        
    </div>

    <div class="row">
        <!-- Comments -->
        
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                


            </div>
        
    </div>
</div>

    
    <div id="totop" title="Let me fly">
    <canvas id="totop-canvas" width="48" height="48"></canvas>
    <div id="totop-percent"></div>
</div>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                        <li>
                            <a href="https://twitter.com/brightonzhang" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li>
                            <a href="https://github.com/brightonzhang" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    
                        <li>
                            <a href="mailto:hello@brightonzhang.com" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>

                <p class="copyright text-muted">
                    &copy; 2019 Brighton Zhang<br>
                    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> ⌘ 
                    Theme from <a href="https://github.com/brightonzhang/hexo-theme-nutshell" target="_blank">Nutshell</a>
                    
                    ⌘ Deployed on <a href="https://github.com/brightonzhang/brightonzhang.com.git" target="_blank">GitHub Pages</a>
                    
                </p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<!-- Disqus Comments -->





    <script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>


<script src="/js/script.js"></script>


</body>

</html>